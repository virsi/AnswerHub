{% extends 'base.html' %}
{% load static %}

{% block title %}{{ question.title }} - AnswerHub{% endblock %}

{% block content %}
<div class="main-layout">
    <div class="content">
        <!-- –í–æ–ø—Ä–æ—Å -->
        <div class="question-card">
            <div class="vote-buttons">
                <form method="post" action="{% url 'questions:vote' question.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="1" class="vote-btn vote-up">‚Üë</button>
                </form>
                <span class="vote-count">{{ question.votes }}</span>
                <form method="post" action="{% url 'questions:vote' question.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="-1" class="vote-btn vote-down">‚Üì</button>
                </form>
            </div>

            <div class="question-content">
                <h1>{{ question.title }}</h1>
                <div class="question-body">
                    {{ question.content|linebreaks }}
                </div>

                <div class="tags">
                    {% for tag in question.tags.all %}
                    <a href="{% url 'tags:detail' tag.name %}" class="tag">{{ tag.name }}</a>
                    {% empty %}
                    <span class="tag">–±–µ–∑ —Ç–µ–≥–∞</span>
                    {% endfor %}
                </div>

                <div class="meta">
                    <span>—Å–ø—Ä–æ—Å–∏–ª {{ question.created_at|timesince }} –Ω–∞–∑–∞–¥</span>
                    <span>–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: {{ question.views }}</span>
                    <div class="author-info">
                        <div class="user-avatar-small">
                            <img src="{% if question.author.avatar %}{{ question.author.avatar.url }}{% else %}{% static 'img/avatar-placeholder.jpg' %}{% endif %}"
                                 alt="–ê–≤–∞—Ç–∞—Ä {{ question.author.username }}" class="avatar-img">
                        </div>
                        <span>{{ question.author.username }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –û—Ç–≤–µ—Ç—ã -->
        <div class="answers-header">
            <h2>{{ question.answers.count }} –æ—Ç–≤–µ—Ç–æ–≤</h2>
        </div>

        {% for answer in question.answers.all %}
        <div class="answer-card {% if answer.is_correct %}correct{% endif %}">
            <div class="vote-buttons">
                <form method="post" action="{% url 'answers:vote' answer.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="1" class="vote-btn vote-up">‚Üë</button>
                </form>
                <span class="vote-count">{{ answer.votes }}</span>
                <form method="post" action="{% url 'answers:vote' answer.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="-1" class="vote-btn vote-down">‚Üì</button>
                </form>
            </div>

            <div class="answer-content">
                <div class="answer-body">
                    {{ answer.content|linebreaks }}
                </div>

                <div class="answer-meta">
                    {% if answer.is_correct %}
                    <div class="correct-answer">
                        <span class="correct-badge">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</span>
                    </div>
                    {% elif question.author == user %}
                    <form method="post" action="{% url 'answers:mark_correct' answer.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π</button>
                    </form>
                    {% endif %}

                    <div class="meta">
                        <span>–æ—Ç–≤–µ—Ç–∏–ª {{ answer.created_at|timesince }} –Ω–∞–∑–∞–¥</span>
                        <div class="author-info">
                            <div class="user-avatar-small">
                                <img src="{% if answer.author.avatar %}{{ answer.author.avatar.url }}{% else %}{% static 'img/avatar-placeholder.jpg' %}{% endif %}"
                                     alt="–ê–≤–∞—Ç–∞—Ä {{ answer.author.username }}" class="avatar-img">
                            </div>
                            <span>{{ answer.author.username }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-answers">
            <h3>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤</h3>
            <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å!</p>
        </div>
        {% endfor %}

        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞ (–ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–æ–≤) -->
        {% if user == question.author %}
        <div class="delete-action">
            <button class="btn btn-danger" id="deleteQuestionBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
        </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
        {% if user.is_authenticated %}
        <div class="answer-form-card">
            <h3>–í–∞—à –æ—Ç–≤–µ—Ç</h3>
            <form class="answer-form" method="post" action="{% url 'answers:create' question.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" class="form-textarea" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </form>
        </div>
        {% else %}
        <div class="auth-prompt">
            <p>–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å, <a href="{% url 'users:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="{% url 'users:signup' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>.</p>
        </div>
        {% endif %}
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    {% if user == question.author %}
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å "<strong>{{ question.title }}</strong>"?</p>
                <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã.</p>
            </div>
            <div class="modal-actions">
                <form method="post" action="{% url 'questions:delete' question.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                </form>
                <button class="btn btn-outline modal-cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    {% endif %}

    <aside class="sidebar">
        {% include 'includes/sidebar_popular_tags.html' %}
        {% include 'includes/sidebar_top_users.html' %}
    </aside>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
.delete-action {
    margin: 2rem 0;
    text-align: right;
}

.btn-danger {
    background: var(--danger);
    color: white;
    border: 1px solid var(--danger);
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    box-shadow: 0 2px 4px rgba(250, 82, 82, 0.3);
}

.btn-danger:hover {
    background: #e03131;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(250, 82, 82, 0.4);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--bg-main);
    margin: 15% auto;
    padding: 0;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
}

.modal-body {
    padding: 1.5rem;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid var(--border);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('deleteQuestionBtn');
    if (deleteBtn) {
        const modal = document.getElementById('deleteModal');
        const closeBtn = document.querySelector('.modal-close');
        const cancelBtn = document.querySelector('.modal-cancel');

        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'block';
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        window.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    }
});
</script>
{% endblock %}
