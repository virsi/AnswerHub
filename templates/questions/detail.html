{% extends 'base.html' %}
{% load static %}

{% block title %}{{ question.title }} - AnswerHub{% endblock %}

{% block content %}
<div class="main-layout">
    <div class="content">
        <!-- Вопрос -->
        <div class="question-card">
            <div class="vote-buttons">
                <form method="post" action="{% url 'questions:vote' question.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="1" class="vote-btn vote-up">↑</button>
                </form>
                <span class="vote-count">{{ question.votes }}</span>
                <form method="post" action="{% url 'questions:vote' question.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="-1" class="vote-btn vote-down">↓</button>
                </form>
            </div>

            <div class="question-content">
                <h1>{{ question.title }}</h1>
                <div class="question-body">
                    {{ question.content|linebreaks }}
                </div>

                <div class="tags">
                    {% for tag in question.tags.all %}
                    <a href="{% url 'tags:detail' tag.name %}" class="tag">{{ tag.name }}</a>
                    {% empty %}
                    <span class="tag">без тега</span>
                    {% endfor %}
                </div>

                <div class="meta">
                    <span>спросил {{ question.created_at|timesince }} назад</span>
                    <span>просмотров: {{ question.views }}</span>
                    <div class="author-info">
                        <div class="user-avatar-small">
                            <img src="{% if question.author.avatar %}{{ question.author.avatar.url }}{% else %}{% static 'img/avatar-placeholder.jpg' %}{% endif %}"
                                 alt="Аватар {{ question.author.username }}" class="avatar-img">
                        </div>
                        <span>{{ question.author.username }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ответы -->
        <div class="answers-header">
            <h2>{{ question.answers.count }} ответов</h2>
        </div>

        {% for answer in question.answers.all %}
        <div class="answer-card {% if answer.is_correct %}correct{% endif %}">
            <div class="vote-buttons">
                <form method="post" action="{% url 'answers:vote' answer.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="1" class="vote-btn vote-up">↑</button>
                </form>
                <span class="vote-count">{{ answer.votes }}</span>
                <form method="post" action="{% url 'answers:vote' answer.id %}">
                    {% csrf_token %}
                    <button type="submit" name="value" value="-1" class="vote-btn vote-down">↓</button>
                </form>
            </div>

            <div class="answer-content">
                <div class="answer-body">
                    {{ answer.content|linebreaks }}
                </div>

                <div class="answer-meta">
                    {% if answer.is_correct %}
                    <div class="correct-answer">
                        <span class="correct-badge">✓ Правильный ответ</span>
                    </div>
                    {% elif question.author == user %}
                    <form method="post" action="{% url 'answers:mark_correct' answer.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline">Отметить как правильный</button>
                    </form>
                    {% endif %}

                    <!-- Кнопка удаления ответа для автора -->
                    {% if user == answer.author %}
                    <div class="answer-actions">
                        <button class="btn-text btn-text-danger delete-answer-btn"
                                data-answer-id="{{ answer.id }}">
                            Удалить
                        </button>
                    </div>
                    {% endif %}

                    <div class="meta">
                        <span>ответил {{ answer.created_at|timesince }} назад</span>
                        <div class="author-info">
                            <div class="user-avatar-small">
                                <img src="{% if answer.author.avatar %}{{ answer.author.avatar.url }}{% else %}{% static 'img/avatar-placeholder.jpg' %}{% endif %}"
                                     alt="Аватар {{ answer.author.username }}" class="avatar-img">
                            </div>
                            <span>{{ answer.author.username }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-answers">
            <h3>Пока нет ответов</h3>
            <p>Будьте первым, кто ответит на этот вопрос!</p>
        </div>
        {% endfor %}

        <!-- Кнопка удаления для автора (после ответов) -->
        {% if user == question.author %}
        <div class="delete-action">
            <button class="btn-text btn-text-danger" id="deleteQuestionBtn">Удалить вопрос</button>
        </div>
        {% endif %}

        <!-- Форма ответа -->
        {% if user.is_authenticated %}
        <div class="answer-form-card">
            <h3>Ваш ответ</h3>
            <form class="answer-form" method="post" action="{% url 'answers:create' question.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" class="form-textarea" rows="8" placeholder="Введите ваш ответ..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Отправить ответ</button>
            </form>
        </div>
        {% else %}
        <div class="auth-prompt">
            <p>Чтобы ответить на вопрос, <a href="{% url 'users:login' %}">войдите</a> или <a href="{% url 'users:signup' %}">зарегистрируйтесь</a>.</p>
        </div>
        {% endif %}
    </div>

    <!-- Модальное окно подтверждения удаления вопроса -->
    {% if user == question.author %}
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Удаление вопроса</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить вопрос "<strong>{{ question.title }}</strong>"?</p>
                <p>Это действие нельзя отменить. Все ответы на этот вопрос также будут скрыты.</p>
            </div>
            <div class="modal-actions">
                <form method="post" action="{% url 'questions:delete' question.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Удалить вопрос</button>
                </form>
                <button class="btn btn-outline modal-cancel">Отмена</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Модальное окно подтверждения удаления ответа -->
    {% if user.is_authenticated %}
    <div id="deleteAnswerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Удаление ответа</h3>
                <button class="modal-close-answer">&times;</button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить этот ответ?</p>
                <p>Это действие нельзя отменить.</p>
            </div>
            <div class="modal-actions">
                <form id="deleteAnswerForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Удалить ответ</button>
                </form>
                <button class="btn btn-outline modal-cancel-answer">Отмена</button>
            </div>
        </div>
    </div>
    {% endif %}

    <aside class="sidebar">
        {% include 'includes/sidebar_popular_tags.html' %}
        {% include 'includes/sidebar_top_users.html' %}
    </aside>
</div>

<style>
/* Стили для кнопки удаления вопроса */
.delete-action {
    margin: 2rem 0;
    text-align: right;
}

/* Стили для текстовых кнопок */
.btn-text {
    background: none;
    border: none;
    color: var(--text-secondary);
    text-decoration: none;
    cursor: pointer;
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    transition: all 0.2s;
}

.btn-text-danger {
    color: var(--danger);
    text-decoration: underline;
}

.btn-text-danger:hover {
    color: #e03131;
    background: rgba(250, 82, 82, 0.1);
    border-radius: 3px;
}

/* Стили для кнопок действий ответа */
.answer-actions {
    margin: 0.25rem 0;
}

.answer-meta {
    display: flex;
    flex-direction:row-reverse;
    gap: 0.5rem;
}

.btn-danger {
    background: var(--danger);
    color: white;
    border: 1px solid var(--danger);
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    box-shadow: 0 2px 4px rgba(250, 82, 82, 0.3);
}

.btn-danger:hover {
    background: #e03131;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(250, 82, 82, 0.4);
}

/* Модальное окно */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--bg-main);
    margin: 15% auto;
    padding: 0;
    border-radius: var(--radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.modal-close,
.modal-close-answer {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
}

.modal-body {
    padding: 1.5rem;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1.5rem;
    border-top: 1px solid var(--border);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Удаление вопроса
    const deleteQuestionBtn = document.getElementById('deleteQuestionBtn');
    if (deleteQuestionBtn) {
        const questionModal = document.getElementById('deleteModal');
        const closeQuestionBtn = document.querySelector('.modal-close');
        const cancelQuestionBtn = document.querySelector('.modal-cancel');

        deleteQuestionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            questionModal.style.display = 'block';
        });

        function closeQuestionModal() {
            questionModal.style.display = 'none';
        }

        if (closeQuestionBtn) {
            closeQuestionBtn.addEventListener('click', closeQuestionModal);
        }
        if (cancelQuestionBtn) {
            cancelQuestionBtn.addEventListener('click', closeQuestionModal);
        }

        window.addEventListener('click', function(e) {
            if (e.target === questionModal) {
                closeQuestionModal();
            }
        });
    }

    // Удаление ответов
    const deleteAnswerBtns = document.querySelectorAll('.delete-answer-btn');
    const answerModal = document.getElementById('deleteAnswerModal');
    const deleteAnswerForm = document.getElementById('deleteAnswerForm');
    const closeAnswerBtn = document.querySelector('.modal-close-answer');
    const cancelAnswerBtn = document.querySelector('.modal-cancel-answer');

    if (deleteAnswerBtns.length > 0 && answerModal) {
        deleteAnswerBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const answerId = this.getAttribute('data-answer-id');
                const actionUrl = "{% url 'answers:delete' 0 %}".replace('0', answerId);
                deleteAnswerForm.action = actionUrl;
                answerModal.style.display = 'block';
            });
        });

        function closeAnswerModal() {
            answerModal.style.display = 'none';
        }

        if (closeAnswerBtn) {
            closeAnswerBtn.addEventListener('click', closeAnswerModal);
        }
        if (cancelAnswerBtn) {
            cancelAnswerBtn.addEventListener('click', closeAnswerModal);
        }

        window.addEventListener('click', function(e) {
            if (e.target === answerModal) {
                closeAnswerModal();
            }
        });
    }
});
</script>
{% endblock %}
